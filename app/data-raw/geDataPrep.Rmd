
```{r knitr-opts, echo = FALSE}
library(knitr)
opts_chunk$set(message = FALSE, echo = FALSE, warning = FALSE)
```

```{r, load-utils}
library(Rlabkey)
library(data.table)
source("../R/utils.R")
```

```{r, get-studies-to-use}
geMetaData <- labkey.selectRows(
                        baseUrl = "https://www.immunespace.org",
                        folderPath = "/Studies/",
                        schemaName = "assay.ExpressionMatrix.matrix",
                        queryName = "inputSamples_computed",
                        colNameOpt = "rname")
keepCols <- c("biosample_participantid",
              "biosample_study_time_collected",
              "run_dataoutputs_name")
geMetaData <- geMetaData[ , colnames(geMetaData) %in% keepCols ]

geMetaData$study <- paste0("SDY", sapply(strsplit(geMetaData$biosample_participantid, "\\."), "[", 2))
geMetaData$expression_matrix <- gsub("\\.tsv", "", geMetaData$run_dataoutputs_name)

geMetaData <- geMetaData[ geMetaData$biosample_study_time_collected >= 0, ]
geMetaData <- data.table(geMetaData)

geMetaData <- geMetaData[ , hasData := 0 %in% unique(biosample_study_time_collected) &
                                       length(unique(biosample_study_time_collected)) > 1,
                            by = .(biosample_participantid)]
geMetaData <- geMetaData[ hasData == TRUE ]
```

```{r, retrieve-data-loop-alternative}
library(ImmuneSpaceR)
library(Biobase)
esets <- lapply(unique(geMetaData$study), function(study){
    con <- CreateConnection(study)
    eset <- con$getGEMatrix(con$cache$GE_matrices$name)
})

# Combine esets
eset <- ImmuneSpaceR:::.combineEMs(esets)
```

```{r, separate-expression-data}
# subset eset by pids in geMetaData$hasData
pidsWithData <- unique(geMetaData$biosample_participantid)
eset <- eset[ , eset$participant_id %in% pidsWithData ]
saveRDS(eset, file = "data/eset.rds")

# for each pid in pData generate
pd <- pData(eset)
em <- exprs(eset)
pids <- unique(pd$participant_id)

tmp <- data.frame(matrix(nrow = nrow(em), ncol = length(pids)))
rownames(tmp) <- rownames(em)
colnames(tmp) <- pids

for(pid in pids){
    baseline <- eset[ , eset$participant_id == pid & eset$study_time_collected == 0 ]
    baselineEm <- exprs(baseline)[,1]
    post <- eset[ , eset$participant_id == pid & eset$study_time_collected != 0 ]
    postEm <- exprs(post)
    maxEm <- apply(postEm, 1, max)
    tmp[, match(pid, colnames(tmp))] <- maxEm - baselineEm
}

fc <- data.table(tmp, keep.rownames = TRUE)
```

```{r, create-pdata}
keepCols <- c("participant_id", "exposure_process_preferred")
pd <- pd[, colnames(pd) %in% keepCols]
pd <- pd[ !duplicated(pd), ]

# Demographics
demographics <- labkey.selectRows(
    baseUrl = "https://www.immunespace.org",
    folderPath = "/Studies/",
    schemaName = "study",
    queryName = "demographics",
    colNameOpt = "rname"
)
keepCols <- c("participantid", "gender", "age_reported", "ethnicity", "race")
demographics <- demographics[ , colnames(demographics) %in% keepCols]
pd <- merge(pd, demographics, by.x = "participant_id", by.y = "participantid")

# Condition
studyInfo <- labkey.selectRows(
    baseUrl = "https://www.immunespace.org",
    folderPath = "/Studies/",
    schemaName = "immport",
    queryName = "study",
    colNameOpt = "rname"
)

pd <- addStudy(pd)

pd$condition <- studyInfo$condition_studied[ match(pd$study, studyInfo$study_accession)]

pd <- addMappedCondition(pd)

pdata <- pd
```


```{r, shared-summary-variables}
groupingVar <- "newCondition"
btms <- UpdateAnno::emory_blood_transcript_modules
```


```{r, summarize-data-for-grouped-box-plot}
# Genes first
genesDT <- melt(fc,
                id.vars = c("rn"),
                measure.vars = grep("rn",
                                      colnames(fc),
                                      value = TRUE,
                                      invert = TRUE)
                  )
setnames(genesDT, c("variable", "rn"), c("participantId","gbValue"))

# BTMs
summarizeBTM <- function(geneDFsubset){
    res <- unname(sapply(names(btms), function(nm){
      d <- mean(geneDFsubset[ gbValue %in% btms[[nm]], value ])
    }))
}

btmsDT <- genesDT[ , list(value = summarizeBTM(.SD),
                          gbValue = names(btms)),
                     by = "participantId"]

# Add back grouping variables to facilitate plotting
addPlottingColumns <- function(dt){
    dt[, Condition := pdata$newCondition[match(dt$participantId, pdata$participant_id)] ]
    dt[, Study := gsub("^SUB\\d+\\.", "SDY", dt$participantId) ]
}

genesDT <- addPlottingColumns(genesDT)
btmsDT <- addPlottingColumns(btmsDT)

boxPlotData <- list(Gene = genesDT, Btm = btmsDT)
```


```{r, save-output}
outputPath <- "../data/"
saveRDS(boxPlotData, file = paste0(outputPath, "GE_boxplot_data.rds"))
```

